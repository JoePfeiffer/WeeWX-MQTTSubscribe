version: 1.5.2-rc{build}
image: Ubuntu1804
stack: python 3.7
environment:
  SKEY: 82042921343dcec70c2a48eaa947b723ea9afdd5
  COVERALLS_REPO_TOKEN: DKSmdX1H70csSzemlw7Yjv6oe5QXrZ0uX
build_script:
- sh: >-
    export SONAR_SCANNER_VERSION=4.2.0.1873

    export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux

    curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip

    unzip -qq -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/

    export PATH=$SONAR_SCANNER_HOME/bin:$PATH

    export SONAR_SCANNER_OPTS="-server"



    pip install configobj

    pip install paho-mqtt

    pip install mock

    pip install pylint

    pip install coveralls --user --no-warn-script-location --no-python-version-warning

    pip install nose --user --no-warn-script-location --no-python-version-warning

    pip install coverage --user --no-warn-script-location --no-python-version-warning

    export PATH=/home/appveyor/.local/bin:$PATH

    #./coverage.sh


    PYTHONPATH=bin nosetests ./bin/user/tests/unit --exe --exclude=setup --cover-package=user.MQTTSubscribe --with-coverage --cover-branches --cover-xml --logging-level=DEBUG


    # sed -i 's/filename="/filename=".\//g' coverage.xml


    coveralls


    pylint ./bin/user/MQTTSubscribe.py -r n --msg-template="{path}:{line}: [{msg_id}({symbol}), {obj}] {msg}" | tee pylint.txt


    sonar-scanner \
      -Dsonar.organization=bellrichm \
      -Dsonar.projectKey=bellrichm_WeeWX-MQTTSubscribe \
      -Dsonar.sources=./bin/user/MQTTSubscribe.py \
      -Dsonar.tests=./bin/user/tests/unit \
      -Dsonar.language=py \
      -Dsonar.python.xunit.reportPath=nosetests.xml \
      -Dsonar.python.coverage.reportPaths=coverage.xml \
      -Dsonar.python.coveragePlugin=cobertura \
      -D sonar.python.pylint.reportPath=pylint.txt \
      -Dsonar.host.url=https://sonarcloud.io \
      -Dsonar.login=$SKEY \
      #-X

    #-Dsonar.python.xunit.reportPath=nosetests.xml

    #-Dsonar.python.coverage.reportPath=coverage.xml

    #-Dsonar.python.coveragePlugin=cobertura


    ls -la


    python --version
test: off